
# 慢查询分析经历

## 构建慢查询
* 表对象：cronix_job_log

表大小：
```
mysql> SELECT COUNT(*) AS total_runs FROM cronix_job_log ;
+------------+
| total_runs |
+------------+
|     794371 |
+------------+
1 row in set (0.11 sec)
```
可见，在压力测试下有794371条记录，这是一个较大的数据集。
当有需求：根据时间查询：
```
SELECT * FROM cronix_job_log  ORDER BY start_time DESC  LIMIT 4;
```
查询时间达到了1+秒，这是一个比较慢的查询。

## 打开并设置慢查询日志
```shell
# 打开慢查询日志
SET GLOBAL slow_query_log = ON;
# 设置慢查询阈值（秒）
SET GLOBAL long_query_time = 1;
# 查看慢查询日志状态
SHOW VARIABLES LIKE 'slow_query_log';
# 查看阈值
SHOW VARIABLES LIKE 'long_query_time';
# 查看慢查询日志文件路径
SHOW VARIABLES LIKE 'slow_query_log_file';
```

继续执行同一条sql语句，查看是否会记录到慢查询日志中。
```shell
SELECT * FROM cronix_job_log  ORDER BY start_time DESC  LIMIT 4;
```

```shell
cat /var/lib/mysql/be22550819ea-slow.log

# 查看最后100条慢查询日志
tail -n 100 /var/lib/mysql/be22550819ea-slow.log
```
可以看到上述sql语句记录到了慢查询日志中。记录的信息有：
* 执行时间：1.51 sec
* 执行语句：SELECT * FROM cronix_job_log  ORDER BY start_time DESC  LIMIT 4;
* Rows_examined：793391

扫描的行数非常大，导致慢查询

## 建立索引
为cronix_job_log表的start_time字段建立索引：
```shell
CREATE INDEX idx_cronix_job_log_start_time ON cronix_job_log (start_time DESC);
```

之后的查询几乎 0.00 sec 完成！


