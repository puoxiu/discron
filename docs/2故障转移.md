# 故障转移

> 在本项目中，故障转移主要用于处理节点失效（如节点下线、崩溃或网络中断）时，将失效节点上的任务迁移到其他存活节点，确保任务持续执行。

1. 故障转移的触发
* 当节点因故障下线时，其在 Etcd 中的注册信息会因租约过期被自动删除，触发DELETE事件，这时候调度中心协程会感知到这一事件
* 调度中心会根据节点的UUID，查询数据库中该节点的状态，若状态为NodeConnFail（节点连接失败），则确认节点已失效，需要执行故障转移和邮件/飞鼠/企微告警。

2. 转移核心流程
* 调度中心查询数据库，获取该节点上所有的任务
* 将任务状态设置为未分配
* 调用AutoAllocateNode 选择当前存活节点中已分配任务数最少的节点
* 执行任务分配，更新数据库和etcd信息




