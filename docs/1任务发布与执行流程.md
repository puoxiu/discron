# 任务发布与执行流程介绍

## 调度中心-任务接收与分配

1. 任务提交
* 接收API：/job/add
* 方法：POST
* 参数示例：
```json
{
  "name": "定时清理日志",                   // 任务名称 
  "command": "rm -rf /var/log/*.log",     // 任务执行的实际命令
  "type": 1,                              // 任务类型: 1-cmd任务, 2-http任务
  "spec": "0 0 * * *",                    // cron 表达式，指定任务执行时间、间隔、次数等
  "timeout": 300,                         // 任务执行超时时间，单位秒
  "retry_times": 2,                       // 任务执行失败重试次数
  "retry_interval": 60,                   // 任务执行失败重试间隔时间，单位秒
  "allocation": 2,                        // 分配方式: 1-手动指定, 2-自动分配
  "run_on": "node-uuid-xxx",                      // 手动指定的节点的UUID，仅在allocation=1时生效
  "notify_status": 1,                     // 是否开启失败通知: 1-开启, 2-关闭
  "notify_type": 1,                       // 通知方式: 1-邮件, 2-飞书
  "notify_to_array": [1, 2],              // 通知接收人 ID 列表， 与 notify_type 相关
  "note": "每天凌晨清理日志"       // 任务描述/备注
}
```
* 参数校验：
  * 必传字段校验：name、type、command、spec、allocation缺失时返回参数错误
  * 分配方式校验：手动分配时run_on必须存在且对应节点存活（状态≠NodeConnFail）
  * 命令行任务限制：自动分配时需系统配置CmdAutoAllocation=true，否则禁止自动分配


2. 任务分配
* 自动分配逻辑：
    *  调用AutoAllocateNode方法获取所有当前存活节点，过滤失效节点，并选择分配任务数最小的节点
* 手动分配逻辑：
    * 检查参数中的run_on是否存在，若不存在则返回参数错误
    * 检查run_on指定的节点是否存活（状态≠NodeConnFail），若不存在则返回参数错误，存在则直接分配给该节点

3. 任务持久化与同步
> 找到对应节点后做的事
* 数据库存储：
    新增/更新任务，写入cronix_job表，自动生成ID和created/updated 时间戳
* Etcd同步：
    任务信息序列化后写入 Etcd，路径格式为/cronix/job/<nodeUUID>/<jobID>
 

## 执行节点-任务执行
1. 任务监听：
* 每个节点启动后，都会启动一个持续运行的协程，监听/cronix/job/<nodeUUID>路径，
* 发现新增任务时（感知到PUT事件），解析任务信息，校验任务参数是否完整、合法

2. 任务加载：
* 校验通过后将任务加入本地任务列表，初始化节点信息（IP、主机名等）
* 基于 Cron 表达式创建定时任务（通过github.com/jakecoffman/cron调度器）

3. 任务执行与结果处理
* 两种触发方式：
    * Cron 表达式触发：根据任务的spec字段，定时执行任务
    * Once 接口触发：通过调用任务的Once方法，立即执行任务

* 执行时：
    * 超时控制：通过context.WithTimeout限制执行时长，超时终止进程
    * 重试机制：失败后按retry_times和retry_interval重试（默认间隔随次数递增）
    * 进程状态：在 Etcd 中写入任务运行状态（/cronix/proc/<nodeUUID>/<jobID>/<pid>），包含进程 ID 和开始时间

* 结果处理：
    * 成功 / 失败状态更新至日志表（success字段：1 成功，0 失败），记录输出内容和结束时间（存储在Mysql的cronix_job_log表中）
    * 失败通知：若开启通知，按notify_type向notify_to_array指定的接收人发送通知（邮件或飞书）

